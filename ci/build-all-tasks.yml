# This YAML is intended for building ALL tasks and publish them as an artifact 
# to be used later for Tasks Deployment train

steps:
# Clean
- checkout: self
  clean: true

# Use node 10, npm 6
- task: NodeTool@0
  displayName: Use node 10
  inputs:
    versionSpec: 10.x

# npm install
- script: npm install
  displayName: npm install

# Clean
- script: node make.js clean
  displayName: Clean tasks

# Build tasks
- script: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
    nvm --version
    nvm install 10.24.1
    nvm use 10.24.1
    node make.js serverBuild
  displayName: Build tasks

# Build tasks Node20
- script: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
    nvm --version
    nvm install 20.3.1
    nvm use 20.3.1
    node make.js serverBuild --node Node20
  displayName: Build tasks Node20

# Stage tasks individually into the package directory
- script: node ./ci/stage-package.js true individually
  displayName: Stage tasks individually into the package directory

- script: |
    rmdir /s /q _build
    rmdir /s /q _package\nested-zips-layout
  displayName: Remove _build folder to reduce space

# Sign all task zips as nuget packages
- template: sign-all-tasks.yml
  parameters:
    layoutRoot: $(Build.SourcesDirectory)\_package\tasks-layout

# Stage all the tasks into a single zip for upload
- script: node ./ci/stage-package.js true
  displayName: Stage all the tasks into a single zip for upload

# Publish artifact
- task: PublishBuildArtifacts@1
  displayName: Publish package artifact
  inputs:
    pathToPublish: _package/tasks.zip
    artifactName: allTasks
    publishLocation: container
